<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„Ç∞„ÉÉ„Ç∫ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - AI„ÇØ„É©„Ç¶„ÉâÁâà</title>
    
    <!-- iOS PWA Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #F2F2F7;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ai-loading-effect { animation: pulse 1.5s infinite; border: 2px solid #3B82F6; }
        .modal-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // --- Firebase ÈÖçÁΩÆ ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-merch-app-default';
        let app, auth, db;
        
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        const apiKey = ""; // Gemini API Key

        const i18n = {
            ja: {
                title: "„ÇØ„É©„Ç¶„Éâ„Ç∞„ÉÉ„Ç∫ÁÆ°ÁêÜ",
                search: "Ê§úÁ¥¢...",
                all: "„Åô„Åπ„Å¶",
                acrylic: "„Ç¢„ÇØ„É™„É´",
                badge: "Áº∂„Éê„ÉÉ„Ç∏",
                apparel: "„Ç¢„Éë„É¨„É´",
                goods: "ÁîüÊ¥ªÈõëË≤®",
                others: "„Åù„ÅÆ‰ªñ",
                add: "Êñ∞Ë¶èÁôªÈå≤",
                edit: "ÂïÜÂìÅÊÉÖÂ†±",
                name: "ÂïÜÂìÅÂêç",
                series: "‰ΩúÂìÅÂêç",
                category: "„Ç´„ÉÜ„Ç¥„É™",
                memo: "„É°„É¢ / AIÂàÜÊûê",
                save: "‰øùÂ≠ò",
                cancel: "„Ç≠„É£„É≥„Çª„É´",
                delete: "ÂâäÈô§",
                ai_analyzing: "AIÂàÜÊûê‰∏≠...",
                upload_tip: "ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶AIËµ∑Âãï",
                settings: "Ë®≠ÂÆö",
                lang_select: "Ë®ÄË™ûÂàá„ÇäÊõø„Åà",
                list: "‰∏ÄË¶ß",
                material: "Á¥†Êùê",
                syncing: "ÂêåÊúü‰∏≠..."
            },
            zh: {
                title: "Èõ≤Á´ØÈÄ±ÈÇäÁÆ°ÁêÜ",
                search: "ÊêúÂ∞ãÂêçÁ®±Êàñ‰ΩúÂìÅ...",
                all: "ÂÖ®ÈÉ®",
                acrylic: "Â£ìÂÖãÂäõ",
                badge: "ÂæΩÁ´†",
                apparel: "ÊúçÈ£æ",
                goods: "ÁîüÊ¥ªÁî®ÂìÅ",
                others: "ÂÖ∂‰ªñ",
                add: "Êñ∞Â¢ûÂïÜÂìÅ",
                edit: "Á∑®ËºØË©≥ÊÉÖ",
                name: "ÂïÜÂìÅÂêçÁ®±",
                series: "‰ΩúÂìÅÁ≥ªÂàó",
                category: "ÂàÜÈ°û",
                memo: "ÂÇôË®ª / AI ÊèèËø∞",
                save: "ÂÑ≤Â≠òÂà∞Èõ≤Á´Ø",
                cancel: "ÂèñÊ∂à",
                delete: "ÂæûÈõ≤Á´ØÂà™Èô§",
                ai_analyzing: "AI Ëæ®Ë≠ò‰∏≠...",
                upload_tip: "ÈªûÊìä‰∏äÂÇ≥ÂïüÂãï AI Ëæ®Ë≠ò",
                settings: "Ë®≠ÂÆö",
                lang_select: "Ë™ûË®ÄÂàáÊèõ",
                list: "Ê∏ÖÂñÆ",
                material: "ÊùêË≥™Á¥∞ÁØÄ",
                syncing: "ÂêåÊ≠•‰∏≠..."
            }
        };

        // ÂúñÁâáÂ£ìÁ∏ÆËºîÂä©ÂáΩÊï∏ (Á∂≠ÊåÅÂú® 1MB ‰ª•‰∏ã)
        const compressImage = (base64Str, maxWidth = 800, maxHeight = 800) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            });
        };

        function App() {
            const [user, setUser] = useState(null);
            const [lang, setLang] = useState('ja'); // È†êË®≠Ë™ûË®ÄÊîπÁÇ∫Êó•Êñá
            const [products, setProducts] = useState([]);
            const [activeNav, setActiveNav] = useState('list');
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTab, setActiveTab] = useState('all');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [isAiAnalyzing, setIsAiAnalyzing] = useState(false);
            const [loading, setLoading] = useState(true);
            const fileInputRef = useRef(null);

            const t = i18n[lang] || i18n.ja;
            const categories = ['all', 'acrylic', 'badge', 'apparel', 'goods', 'others'];

            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth error", e); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const merchRef = collection(db, 'artifacts', appId, 'public', 'data', 'merch');
                const unsubscribe = onSnapshot(merchRef, (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProducts(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Firestore error", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const analyzeWithAI = async (base64Image) => {
                setIsAiAnalyzing(true);
                try {
                    const imageData = base64Image.split(',')[1];
                    const prompt = `Analyze this merchandise photo. Return strictly valid JSON in language ${lang === 'ja' ? 'Japanese' : 'Traditional Chinese'}:
                    {
                      "name": "Detected item name",
                      "series": "Anime/Character series name",
                      "category": "Pick one from [acrylic, badge, apparel, goods, others]",
                      "material": "Likely material info",
                      "description": "Short visual summary"
                    }`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: "image/jpeg", data: imageData } }
                                ]
                            }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const result = await response.json();
                    const aiData = JSON.parse(result.candidates[0].content.parts[0].text);

                    setEditingProduct(prev => ({
                        ...prev,
                        name: aiData.name || prev.name,
                        series: aiData.series || prev.series,
                        category: aiData.category || prev.category,
                        material: aiData.material || prev.material,
                        memo: `[AI] ${aiData.description}\n${prev.memo}`
                    }));
                } catch (error) {
                    console.error("AI Analysis failed", error);
                } finally {
                    setIsAiAnalyzing(false);
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const originalBase64 = reader.result;
                        const compressedBase64 = await compressImage(originalBase64);
                        setEditingProduct(prev => ({ ...prev, image: compressedBase64 }));
                        analyzeWithAI(compressedBase64);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSave = async () => {
                if (!editingProduct.name || !user) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'merch', editingProduct.id);
                const savePayload = {
                    ...editingProduct,
                    updatedAt: serverTimestamp(),
                    lastUpdatedBy: user.uid,
                    isNew: false
                };
                try {
                    await setDoc(docRef, savePayload);
                    setIsModalOpen(false);
                } catch (e) {
                    console.error("Save error", e);
                }
            };

            const handleDelete = async () => {
                if (!user || !editingProduct) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'merch', editingProduct.id);
                try {
                    await deleteDoc(docRef);
                    setIsModalOpen(false);
                } catch (e) { console.error("Delete error", e); }
            };

            const filteredProducts = products.filter(p => 
                (p.name?.toLowerCase().includes(searchQuery.toLowerCase()) || p.series?.toLowerCase().includes(searchQuery.toLowerCase())) &&
                (activeTab === 'all' || p.category === activeTab)
            );

            if (!user) return <div className="flex h-screen items-center justify-center font-bold text-blue-600">Connecting...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative">
                    <div className="p-4 pt-12">
                        {activeNav === 'list' && (
                            <>
                                <div className="flex justify-between items-end mb-6">
                                    <div>
                                        <h1 className="text-3xl font-bold tracking-tight text-gray-800">{t.title}</h1>
                                        <p className="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">Cloud Sync Active</p>
                                    </div>
                                    <button onClick={() => {
                                        setEditingProduct({
                                            id: `prod_${Date.now()}`,
                                            name: '',
                                            category: 'acrylic',
                                            series: '',
                                            material: '',
                                            memo: '',
                                            image: '',
                                            isNew: true
                                        });
                                        setIsModalOpen(true);
                                    }} className="bg-blue-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                                        <span className="text-3xl font-light">+</span>
                                    </button>
                                </div>

                                <div className="bg-white/80 rounded-2xl flex items-center px-4 py-3 mb-6 shadow-sm border border-white">
                                    <span className="mr-2 opacity-40">üîç</span>
                                    <input 
                                        className="bg-transparent border-none outline-none w-full text-sm"
                                        placeholder={t.search}
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                </div>

                                <div className="flex overflow-x-auto hide-scrollbar gap-2 mb-6 text-gray-800">
                                    {categories.map(cat => (
                                        <button 
                                            key={cat}
                                            onClick={() => setActiveTab(cat)}
                                            className={`px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all ${activeTab === cat ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-400'}`}
                                        >
                                            {t[cat]}
                                        </button>
                                    ))}
                                </div>

                                {loading ? (
                                    <div className="grid grid-cols-2 gap-4">
                                        {[1,2,3,4].map(i => <div key={i} className="h-48 bg-white rounded-3xl animate-pulse" />)}
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-4">
                                        {filteredProducts.map(p => (
                                            <div key={p.id} onClick={() => { setEditingProduct({...p}); setIsModalOpen(true); }} className="bg-white rounded-3xl overflow-hidden shadow-sm active:opacity-70 transition-opacity border border-gray-100">
                                                <div className="h-36 bg-cover bg-center bg-gray-50" style={{ backgroundImage: `url(${p.image})` }} />
                                                <div className="p-3">
                                                    <p className="text-[10px] text-blue-600 font-bold mb-1 truncate uppercase">{p.series || '---'}</p>
                                                    <h3 className="font-bold text-sm truncate text-gray-800">{p.name}</h3>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </>
                        )}

                        {activeNav === 'settings' && (
                            <div className="modal-up">
                                <h1 className="text-2xl font-bold mb-6 pt-6 text-gray-800">{t.settings}</h1>
                                <div className="bg-white rounded-3xl p-6 shadow-sm space-y-6">
                                    <div>
                                        <label className="text-[10px] text-gray-400 block mb-4 uppercase font-black tracking-widest">{t.lang_select}</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            {['ja', 'zh'].map(l => (
                                                <button 
                                                    key={l}
                                                    onClick={() => setLang(l)}
                                                    className={`py-3 rounded-2xl border-2 font-bold transition-all ${lang === l ? 'border-blue-600 bg-blue-50 text-blue-600' : 'border-gray-50 text-gray-400'}`}
                                                >
                                                    {l === 'ja' ? 'Êó•Êú¨Ë™û' : 'ÁπÅÈ´î‰∏≠Êñá'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t border-gray-100">
                                        <label className="text-[10px] text-gray-400 block mb-2 uppercase font-black tracking-widest">User ID</label>
                                        <p className="text-[10px] font-mono bg-gray-50 p-2 rounded text-gray-500 break-all">{user.uid}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <nav className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md h-20 bg-white/80 ios-blur border-t border-gray-100 flex justify-around items-center px-8 safe-bottom z-40">
                        {[
                            { id: 'list', label: t.list, icon: 'üìã' },
                            { id: 'settings', label: t.settings, icon: '‚öôÔ∏è' }
                        ].map(nav => (
                            <button 
                                key={nav.id} 
                                onClick={() => setActiveNav(nav.id)}
                                className={`flex flex-col items-center flex-1 transition-all ${activeNav === nav.id ? 'text-blue-600 scale-110' : 'text-gray-300'}`}
                            >
                                <span className="text-2xl mb-1">{nav.icon}</span>
                                <span className="text-[10px] font-bold">{nav.label}</span>
                            </button>
                        ))}
                    </nav>

                    {isModalOpen && editingProduct && (
                        <div className="fixed inset-0 z-50 flex items-end">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => !isAiAnalyzing && setIsModalOpen(false)} />
                            <div className="relative w-full max-w-md mx-auto bg-[#F2F2F7] rounded-t-[40px] h-[90vh] flex flex-col modal-up overflow-hidden shadow-2xl">
                                <div className="flex justify-between items-center px-6 py-4 bg-white border-b border-gray-100">
                                    <button onClick={() => setIsModalOpen(false)} className="text-blue-600 font-medium">{t.cancel}</button>
                                    <h2 className="font-bold text-gray-800">{t.edit}</h2>
                                    <button onClick={handleSave} className="text-blue-600 font-bold" disabled={isAiAnalyzing}>{t.save}</button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6 space-y-4">
                                    <div className="flex flex-col items-center mb-6">
                                        <div 
                                            className={`w-40 h-40 bg-white rounded-3xl shadow-sm flex items-center justify-center overflow-hidden transition-all duration-500 relative cursor-pointer ${isAiAnalyzing ? 'ai-loading-effect' : 'border-4 border-white'}`}
                                            onClick={() => !isAiAnalyzing && fileInputRef.current.click()}
                                        >
                                            {editingProduct.image ? (
                                                <img src={editingProduct.image} className="w-full h-full object-cover" />
                                            ) : <div className="flex flex-col items-center opacity-20"><span className="text-4xl mb-2">üì∏</span><span className="text-[10px] font-bold text-gray-800">UPLOAD</span></div>}
                                            
                                            {isAiAnalyzing && (
                                                <div className="absolute inset-0 bg-blue-600/10 flex items-center justify-center">
                                                    <div className="w-6 h-6 border-3 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                                </div>
                                            )}
                                        </div>
                                        <p className="mt-3 text-xs text-blue-600 font-bold tracking-widest uppercase">
                                            {isAiAnalyzing ? t.ai_analyzing : t.upload_tip}
                                        </p>
                                        <input type="file" ref={fileInputRef} className="file-input" onChange={handleFileChange} accept="image/*" />
                                    </div>

                                    <div className="space-y-3">
                                        <div className="bg-white p-4 rounded-2xl shadow-sm">
                                            <label className="text-[10px] text-gray-300 block mb-1 uppercase font-black tracking-widest">{t.name}</label>
                                            <input 
                                                className="w-full bg-transparent outline-none font-bold text-gray-800 text-lg"
                                                value={editingProduct.name}
                                                onChange={e => setEditingProduct({...editingProduct, name: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-white p-4 rounded-2xl shadow-sm text-gray-800">
                                                <label className="text-[10px] text-gray-300 block mb-1 uppercase font-black tracking-widest">{t.series}</label>
                                                <input 
                                                    className="w-full bg-transparent outline-none font-semibold"
                                                    value={editingProduct.series}
                                                    onChange={e => setEditingProduct({...editingProduct, series: e.target.value})}
                                                />
                                            </div>
                                            <div className="bg-white p-4 rounded-2xl shadow-sm">
                                                <label className="text-[10px] text-gray-300 block mb-1 uppercase font-black tracking-widest">{t.category}</label>
                                                <select 
                                                    className="w-full bg-transparent outline-none font-semibold text-blue-600 appearance-none"
                                                    value={editingProduct.category}
                                                    onChange={e => setEditingProduct({...editingProduct, category: e.target.value})}
                                                >
                                                    {categories.filter(c => c !== 'all').map(c => <option key={c} value={c}>{t[c]}</option>)}
                                                </select>
                                            </div>
                                        </div>

                                        <div className="bg-white p-4 rounded-2xl shadow-sm text-gray-800">
                                            <label className="text-[10px] text-gray-300 block mb-1 uppercase font-black tracking-widest">{t.material}</label>
                                            <input 
                                                className="w-full bg-transparent outline-none text-gray-700"
                                                value={editingProduct.material}
                                                onChange={e => setEditingProduct({...editingProduct, material: e.target.value})}
                                            />
                                        </div>

                                        <div className="bg-white p-4 rounded-2xl shadow-sm">
                                            <label className="text-[10px] text-gray-300 block mb-1 uppercase font-black tracking-widest">{t.memo}</label>
                                            <textarea 
                                                className="w-full bg-transparent outline-none text-sm h-32 resize-none text-gray-600 leading-relaxed"
                                                value={editingProduct.memo}
                                                onChange={e => setEditingProduct({...editingProduct, memo: e.target.value})}
                                            />
                                        </div>

                                        {!editingProduct.isNew && (
                                            <button 
                                                onClick={handleDelete}
                                                className="w-full bg-white text-red-500 py-4 rounded-2xl font-bold shadow-sm active:bg-red-50 mt-4"
                                            >
                                                {t.delete}
                                            </button>
                                        )}
                                    </div>
                                    <div className="h-10"></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
