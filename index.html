import React, { useState, useEffect, useRef } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc } from 'firebase/firestore';

// --- Firebase ÂàùÂßãÂåñ (Ë¶èÂâá 1 & 3) ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = !getApps().length ? initializeApp(firebaseConfig) : getApps()[0];
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'goods-archive-v1';

const i18n = {
    ja: {
        title: "„Ç∞„ÉÉ„Ç∫‰øùÁÆ°Â∫´",
        search: "ÂêçÁß∞„ÄÅ„Ç∑„É™„Éº„Ç∫„ÄÅ‰ªïÊßò„ÅßÊ§úÁ¥¢...",
        all: "„Åô„Åπ„Å¶",
        acrylic: "„Ç¢„ÇØ„Çπ„Çø",
        badge: "Áº∂„Éê„ÉÉ„Ç∏",
        apparel: "„Ç¢„Éë„É¨„É´",
        goods: "ÈõëË≤®",
        others: "„Åù„ÅÆ‰ªñ",
        add: "Êñ∞Ë¶èÁôªÈå≤",
        edit: "Ë©≥Á¥∞Á∑®ÈõÜ",
        save: "‰øùÂ≠ò„Åô„Çã",
        cancel: "„Ç≠„É£„É≥„Çª„É´",
        delete: "ÂâäÈô§„Åô„Çã",
        upload_tip: "ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
        online: "„Ç™„É≥„É©„Ç§„É≥ÂêåÊúü‰∏≠",
        syncing: "ÂêåÊúü‰∏≠",
        name: "„Ç∞„ÉÉ„Ç∫ÂêçÁß∞",
        series: "‰ΩúÂìÅÂêç / „Ç∑„É™„Éº„Ç∫",
        category: "„Ç´„ÉÜ„Ç¥„É™„Éº",
        crafts: "‰ªïÊßò / Âä†Â∑• (‰æã: „Éõ„É≠„Ç∞„É©„É†„ÄÅ‰∏°Èù¢)",
        memo: "„É°„É¢ / Ë≥ºÂÖ•Â†¥ÊâÄ„Å™„Å©"
    }
};

export default function App() {
    const [user, setUser] = useState(null);
    const [products, setProducts] = useState([]);
    const [searchQuery, setSearchQuery] = useState('');
    const [activeTab, setActiveTab] = useState('all');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingProduct, setEditingProduct] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const fileInputRef = useRef(null);

    const t = i18n.ja;
    const categories = ['all', 'acrylic', 'badge', 'apparel', 'goods', 'others'];

    // 1. Ë™çË≠âË®≠ÁΩÆ (Ë¶èÂâá 3)
    useEffect(() => {
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth error", e);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, (u) => {
            setUser(u);
            if (u) setIsLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // 2. Âç≥ÊôÇË≥áÊñôÂ∫´ÂêåÊ≠• (Ë¶èÂâá 1 & 2)
    useEffect(() => {
        if (!user) return;
        
        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'merch');
        
        const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setProducts(data.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0)));
        }, (error) => {
            console.error("Firestore Error:", error);
        });

        return () => unsubscribe();
    }, [user]);

    // ËôïÁêÜÂúñÁâáÈÅ∏Êìá
    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                setEditingProduct(prev => ({ ...prev, image: reader.result }));
            };
            reader.readAsDataURL(file);
        }
    };

    // ÂÑ≤Â≠òËá≥Ë≥áÊñôÂ∫´
    const handleSave = async () => {
        if (!editingProduct.name || !user) return;
        
        const docId = editingProduct.id || Date.now().toString();
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'merch', docId);
        
        const saveData = {
            ...editingProduct,
            id: docId,
            lastUpdatedBy: user.uid,
            updatedAt: Date.now(),
            createdAt: editingProduct.createdAt || Date.now()
        };
        delete saveData.isNew;

        try {
            await setDoc(docRef, saveData);
            setIsModalOpen(false);
        } catch (e) {
            console.error("Save Error", e);
        }
    };

    // Âà™Èô§Ë≥áÊñô
    const handleDelete = async () => {
        if (!editingProduct.id || !user) return;
        try {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'merch', editingProduct.id);
            await deleteDoc(docRef);
            setIsModalOpen(false);
        } catch (e) {
            console.error("Delete Error", e);
        }
    };

    const filteredProducts = products.filter(p => 
        (p.name?.toLowerCase().includes(searchQuery.toLowerCase()) || 
         p.series?.toLowerCase().includes(searchQuery.toLowerCase())) &&
        (activeTab === 'all' || p.category === activeTab)
    );

    if (isLoading) return (
        <div className="flex flex-col h-screen items-center justify-center bg-white space-y-4">
            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p className="text-indigo-600 font-bold tracking-widest text-sm italic">SYSTEM LOADING...</p>
        </div>
    );

    return (
        <div className="max-w-md mx-auto min-h-screen pb-24 relative bg-[#F2F2F7] font-sans text-slate-900 select-none">
            <style>{`
                .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
                .hide-scrollbar::-webkit-scrollbar { display: none; }
                .modal-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
                @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            `}</style>

            {/* Ê®ôÈ°åÊ¨Ñ‰Ωç */}
            <div className="p-6 pt-12">
                <div className="flex justify-between items-end mb-8">
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <span className="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400">{t.online}</span>
                        </div>
                        <h1 className="text-4xl font-black tracking-tight">{t.title}</h1>
                        <p className="text-gray-400 text-[11px] mt-1 font-mono">ID: {user?.uid.slice(0, 12)}...</p>
                    </div>
                    <button 
                        onClick={() => {
                            setEditingProduct({ name: '', category: 'acrylic', series: '', crafts: '', memo: '', image: '', isNew: true });
                            setIsModalOpen(true);
                        }} 
                        className="bg-indigo-600 text-white w-14 h-14 rounded-3xl flex items-center justify-center shadow-[0_10px_25px_-5px_rgba(79,70,229,0.4)] active:scale-90 active:bg-indigo-700 transition-all text-3xl"
                    >+</button>
                </div>

                {/* ÊêúÂ∞ãÊ¨Ñ‰Ωç */}
                <div className="bg-white/80 ios-blur rounded-[20px] flex items-center px-5 py-4 mb-6 shadow-sm border border-white focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                    <span className="mr-3 text-lg opacity-40">üîç</span>
                    <input 
                        className="bg-transparent border-none outline-none w-full text-[15px] font-medium placeholder:text-gray-300" 
                        placeholder={t.search} 
                        value={searchQuery} 
                        onChange={e => setSearchQuery(e.target.value)} 
                    />
                </div>

                {/* ÂàÜÈ°ûÊç≤ÂãïÊ¨Ñ */}
                <div className="flex overflow-x-auto hide-scrollbar gap-2.5 mb-8 -mx-2 px-2">
                    {categories.map(cat => (
                        <button 
                            key={cat} 
                            onClick={() => setActiveTab(cat)} 
                            className={`px-5 py-2.5 rounded-2xl text-[13px] font-bold whitespace-nowrap transition-all ${activeTab === cat ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'bg-white text-gray-400 border border-transparent'}`}
                        >
                            {t[cat]}
                        </button>
                    ))}
                </div>

                {/* ÂïÜÂìÅÁ∂≤Ê†º */}
                <div className="grid grid-cols-2 gap-4">
                    {filteredProducts.length === 0 ? (
                        <div className="col-span-2 py-32 text-center flex flex-col items-center justify-center space-y-4 opacity-30">
                            <span className="text-7xl">üì¶</span>
                            <p className="font-black text-sm tracking-widest italic">NO ARCHIVES FOUND</p>
                        </div>
                    ) : filteredProducts.map(p => (
                        <div 
                            key={p.id} 
                            onClick={() => { setEditingProduct({...p}); setIsModalOpen(true); }} 
                            className="bg-white rounded-[32px] overflow-hidden shadow-sm border border-white active:scale-95 transition-all flex flex-col group"
                        >
                            <div className="h-44 bg-slate-100 relative overflow-hidden">
                                {p.image ? (
                                    <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" alt={p.name} />
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center text-3xl opacity-20">üé®</div>
                                )}
                                <div className="absolute top-3 right-3 bg-black/40 ios-blur px-2.5 py-1 rounded-full text-[9px] font-black text-white tracking-wider uppercase">
                                    {t[p.category] || p.category}
                                </div>
                            </div>
                            <div className="p-4 flex-1 flex flex-col">
                                <span className="text-[10px] text-indigo-500 font-black truncate uppercase mb-1 tracking-widest">{p.series || 'Original'}</span>
                                <h3 className="font-bold text-[14px] text-gray-800 line-clamp-2 leading-tight mb-2">{p.name}</h3>
                                <div className="mt-auto">
                                    <span className="inline-block bg-slate-50 border border-slate-100 text-slate-400 text-[10px] px-2 py-0.5 rounded-md font-bold truncate max-w-full">
                                        {p.crafts || 'Standard'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Á∑®ËºØ‰ªãÈù¢ */}
            {isModalOpen && editingProduct && (
                <div className="fixed inset-0 z-50 flex items-end justify-center">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" onClick={() => setIsModalOpen(false)} />
                    <div className="relative w-full max-w-md bg-[#F2F2F7] rounded-t-[45px] h-[92vh] flex flex-col modal-up overflow-hidden shadow-2xl">
                        
                        {/* ÂΩàÁ™óÈ†ÇÈÉ®Ê¨Ñ‰Ωç */}
                        <div className="flex justify-between items-center px-8 py-6 bg-white/80 ios-blur border-b border-gray-100 z-10">
                            <button onClick={() => setIsModalOpen(false)} className="text-gray-400 font-bold text-sm h-10 px-4 active:opacity-50 transition-opacity">{t.cancel}</button>
                            <h2 className="font-black text-lg tracking-tight">{editingProduct.isNew ? t.add : t.edit}</h2>
                            <button 
                                onClick={handleSave} 
                                className="font-black text-sm h-10 px-6 rounded-full bg-indigo-600 text-white shadow-lg shadow-indigo-100 active:scale-95 transition-all"
                            >{t.save}</button>
                        </div>

                        {/* ÂΩàÁ™óÂÖßÂÆπ */}
                        <div className="flex-1 overflow-y-auto px-6 py-8 space-y-8 hide-scrollbar">
                            
                            {/* ÂúñÁâáÈÅ∏ÂèñÂô® */}
                            <div className="flex flex-col items-center">
                                <div 
                                    className="group relative w-56 h-56 bg-white rounded-[48px] shadow-xl flex items-center justify-center overflow-hidden border-8 border-white hover:border-indigo-50 active:scale-95 transition-all duration-500 cursor-pointer" 
                                    onClick={() => fileInputRef.current.click()}
                                >
                                    {editingProduct.image ? (
                                        <img src={editingProduct.image} className="w-full h-full object-cover" alt="preview" />
                                    ) : (
                                        <div className="flex flex-col items-center opacity-20">
                                            <span className="text-6xl mb-2">üì∏</span>
                                            <span className="text-[10px] font-black tracking-tighter text-center">„Çø„ÉÉ„Éó„Åó„Å¶ÂÜôÁúü„Çí<br/>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                                        </div>
                                    )}
                                </div>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} accept="image/*" />
                                <p className="mt-5 text-[10px] font-black text-indigo-500 uppercase tracking-widest">{t.upload_tip}</p>
                            </div>

                            {/* Ë°®ÂñÆÊ¨Ñ‰Ωç */}
                            <div className="space-y-4">
                                <div className="bg-white p-5 rounded-[28px] shadow-sm">
                                    <label className="text-[10px] text-indigo-400 block mb-2 font-black uppercase tracking-widest">{t.name}</label>
                                    <input 
                                        className="w-full bg-transparent outline-none font-bold text-lg text-slate-800 placeholder:text-slate-200" 
                                        value={editingProduct.name} 
                                        onChange={e => setEditingProduct({...editingProduct, name: e.target.value})} 
                                        placeholder="‰æãÔºöÈõ™„Éü„ÇØ 2024 „Ç¢„ÇØ„É™„É´„Çπ„Çø„É≥„Éâ" 
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-white p-5 rounded-[28px] shadow-sm">
                                        <label className="text-[10px] text-indigo-400 block mb-2 font-black uppercase tracking-widest">{t.series}</label>
                                        <input 
                                            className="w-full bg-transparent outline-none font-bold text-slate-700" 
                                            value={editingProduct.series} 
                                            onChange={e => setEditingProduct({...editingProduct, series: e.target.value})} 
                                            placeholder="‰ΩúÂìÅÂêç / „Ç∑„É™„Éº„Ç∫" 
                                        />
                                    </div>
                                    <div className="bg-white p-5 rounded-[28px] shadow-sm relative">
                                        <label className="text-[10px] text-indigo-400 block mb-2 font-black uppercase tracking-widest">{t.category}</label>
                                        <select 
                                            className="w-full bg-transparent outline-none font-bold text-indigo-600 appearance-none pr-6 cursor-pointer" 
                                            value={editingProduct.category} 
                                            onChange={e => setEditingProduct({...editingProduct, category: e.target.value})}
                                        >
                                            {categories.filter(c => c !== 'all').map(c => <option key={c} value={c}>{t[c]}</option>)}
                                        </select>
                                        <span className="absolute right-6 bottom-6 text-[10px] pointer-events-none opacity-30">‚ñº</span>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-[28px] shadow-sm">
                                    <label className="text-[10px] text-indigo-400 block mb-2 font-black uppercase tracking-widest">{t.crafts}</label>
                                    <input 
                                        className="w-full bg-transparent outline-none font-bold text-slate-700" 
                                        value={editingProduct.crafts} 
                                        onChange={e => setEditingProduct({...editingProduct, crafts: e.target.value})} 
                                        placeholder="„Éõ„É≠„ÄÅÁÆîÊäº„Åó„ÄÅ„Ç∞„É™„ÉÉ„Çø„Éº..." 
                                    />
                                </div>

                                <div className="bg-white p-5 rounded-[28px] shadow-sm">
                                    <label className="text-[10px] text-indigo-400 block mb-2 font-black uppercase tracking-widest">{t.memo}</label>
                                    <textarea 
                                        className="w-full bg-transparent outline-none text-sm h-32 resize-none text-slate-600 leading-relaxed" 
                                        value={editingProduct.memo} 
                                        onChange={e => setEditingProduct({...editingProduct, memo: e.target.value})} 
                                        placeholder="Ë≥ºÂÖ•Â∫ó„ÇÑ‰øùÂ≠òÁä∂ÊÖã„ÄÅÊÑüÊÉ≥„Å™„Å©..."
                                    />
                                </div>
                                
                                {!editingProduct.isNew && (
                                    <button 
                                        onClick={handleDelete} 
                                        className="w-full py-5 text-rose-500 font-black bg-rose-50 rounded-[28px] border border-rose-100 active:scale-95 transition-all mt-4 mb-12 uppercase tracking-widest text-xs"
                                    >
                                        {t.delete}
                                    </button>
                                )}

                                <div className="h-20" /> {/* Â∫ïÈÉ®ÁïôÁôΩ */}
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
