<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的週邊收藏庫</title>
    
    <!-- iOS PWA 標籤 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="週邊管理">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081913.png">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #F2F2F7;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-animate { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // 導入 Firebase 功能
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // 安全地獲取 Firebase 配置 (防止因為變數未定義導致白屏)
        let db, auth, appId;
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-merch-app';
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        const APP_CONFIG = {
            pageTitle: "我的週邊收藏庫",
            categories: ['すべて', 'アクリル', '缶バッジ', 'アパレル', '生活雑貨', 'その他'],
            ui: {
                mainTitle: "收藏清單",
                searchPlaceholder: "検索...",
                btnCancel: "キャンセル",
                btnDone: "完了",
                btnDelete: "削除",
                modalTitle: "商品情報",
                fieldName: "商品名",
                fieldSeries: "作品名",
                fieldCategory: "カテゴリ",
                fieldMemo: "Memo",
                fieldPlaceholder: "未入力",
                btnUpload: "画像をアップロード",
                navHome: "一覧",
                navStats: "製造",
                navSettings: "設定"
            }
        };

        const SearchIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8E8E93" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        );

        const AddIcon = () => (
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#007AFF" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );

        const ImageIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTab, setActiveTab] = useState(APP_CONFIG.categories[0]);
            const [scrolled, setScrolled] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            // 1. 處理身份驗證 (遵守 Rule 3: Auth Before Queries)
            useEffect(() => {
                if (!auth) {
                    setError("Firebase 配置尚未準備就緒，請重整頁面。");
                    return;
                }

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                        // 指數退避重試邏輯可以加在此處，這裡先簡單顯示錯誤
                        setError("登入失敗，正在嘗試重新連線...");
                    }
                };
                
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) setError(null);
                });
                return () => unsubscribe();
            }, []);

            // 2. 處理資料監聽 (遵守 Rule 1 & 2)
            useEffect(() => {
                if (!user || !db) return;

                // Path: /artifacts/{appId}/users/{userId}/merch
                const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'merch');
                
                const unsubscribe = onSnapshot(colRef, 
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setProducts(data);
                        setLoading(false);
                    }, 
                    (err) => {
                        console.error("Firestore error:", err);
                        // 不要使用 alert，改用狀態顯示
                        if (err.code === 'permission-denied') {
                            setError("權限不足或連線逾時，請檢查網路。");
                        }
                    }
                );

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                document.title = APP_CONFIG.pageTitle;
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            const openModal = (product = null) => {
                setEditingProduct(product ? { ...product } : {
                    id: Date.now().toString(),
                    name: '',
                    category: APP_CONFIG.categories[1],
                    series: '',
                    memo: '',
                    image: '' 
                });
                setIsModalOpen(true);
            };

            const closeModal = () => setIsModalOpen(false);

            const handleSave = async () => {
                if (!editingProduct.name || !user) return;
                
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'merch', editingProduct.id);
                try {
                    await setDoc(docRef, editingProduct);
                    closeModal();
                } catch (error) {
                    console.error("Save error:", error);
                }
            };

            const handleDelete = async () => {
                if (!user) return;
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'merch', editingProduct.id);
                try {
                    await deleteDoc(docRef);
                    closeModal();
                } catch (error) {
                    console.error("Delete error:", error);
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 1048576) { 
                        setError("圖片大於 1MB，請縮小後再上傳。");
                        setTimeout(() => setError(null), 3000);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setEditingProduct({ ...editingProduct, image: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const filteredProducts = products.filter(p => 
                (p.name?.toLowerCase().includes(searchQuery.toLowerCase()) || p.series?.toLowerCase().includes(searchQuery.toLowerCase())) &&
                (activeTab === APP_CONFIG.categories[0] || p.category === activeTab)
            );

            // 錯誤畫面
            if (error && !user) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-6 text-center bg-white">
                        <div className="text-red-500 text-5xl mb-4">⚠️</div>
                        <h2 className="text-xl font-bold mb-2">發生了一些問題</h2>
                        <p className="text-gray-500 mb-6">{error}</p>
                        <button onClick={() => window.location.reload()} className="bg-blue-500 text-white px-6 py-2 rounded-full font-bold">
                            重新載入
                        </button>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 bg-[#F2F2F7]">
                    <header className={`fixed top-0 left-0 right-0 z-40 transition-all duration-300 ${scrolled ? 'bg-white/80 ios-blur border-b border-gray-300 h-16' : 'bg-transparent h-28'}`}>
                        <div className="max-w-md mx-auto h-full px-4 flex items-end justify-between pb-2">
                            <h1 className={`font-bold transition-all duration-300 ${scrolled ? 'text-lg w-full text-center' : 'text-3xl'}`}>
                                {APP_CONFIG.ui.mainTitle}
                            </h1>
                            {!scrolled && (
                                <button onClick={() => openModal()} className="text-blue-500 mb-1 active:opacity-50">
                                    <AddIcon />
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="pt-32 px-4">
                        {error && <div className="bg-red-100 text-red-600 p-3 rounded-lg mb-4 text-sm">{error}</div>}
                        
                        <div className="bg-gray-200 rounded-xl flex items-center px-3 py-2 mb-4">
                            <SearchIcon />
                            <input 
                                className="bg-transparent border-none outline-none ml-2 text-[17px] w-full"
                                placeholder={APP_CONFIG.ui.searchPlaceholder}
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>

                        <div className="flex overflow-x-auto hide-scrollbar gap-2 mb-6">
                            {APP_CONFIG.categories.map(tab => (
                                <button 
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`px-4 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${activeTab === tab ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-500'}`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>

                        {loading ? (
                            <div className="text-center py-10 text-gray-400">
                                <div className="animate-spin inline-block w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full mb-2"></div>
                                <p>資料連線中...</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 gap-4">
                                {filteredProducts.map(product => (
                                    <div key={product.id} onClick={() => openModal(product)} className="bg-white rounded-2xl overflow-hidden shadow-sm active:opacity-70 transition-opacity">
                                        <div className="h-36 bg-cover bg-center bg-gray-100 flex items-center justify-center overflow-hidden" style={{ backgroundImage: product.image ? `url(${product.image})` : 'none' }}>
                                            {!product.image && <ImageIcon />}
                                        </div>
                                        <div className="p-3">
                                            <span className="text-[10px] font-bold bg-blue-50 px-1.5 py-0.5 rounded text-blue-600">{product.series}</span>
                                            <h3 className="font-bold text-sm mt-1 truncate">{product.name}</h3>
                                            <p className="text-[11px] text-gray-400 mt-1 truncate">{product.category}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end">
                            <div className="absolute inset-0 bg-black/40" onClick={closeModal} />
                            <div className="relative w-full max-w-md mx-auto bg-[#F2F2F7] rounded-t-2xl h-[92vh] flex flex-col modal-animate overflow-hidden">
                                <div className="flex justify-between items-center px-4 py-3 bg-white border-b border-gray-300">
                                    <button onClick={closeModal} className="text-blue-500 text-lg">{APP_CONFIG.ui.btnCancel}</button>
                                    <h2 className="font-bold">{APP_CONFIG.ui.modalTitle}</h2>
                                    <button onClick={handleSave} className="text-blue-500 font-bold text-lg">{APP_CONFIG.ui.btnDone}</button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-4 pb-20">
                                    <div className="bg-white rounded-xl overflow-hidden mb-6 p-4 flex flex-col items-center">
                                        <div 
                                            className="w-full h-48 rounded-lg bg-gray-100 bg-cover bg-center mb-4 flex items-center justify-center border-2 border-dashed border-gray-200"
                                            style={{ backgroundImage: editingProduct.image ? `url(${editingProduct.image})` : 'none' }}
                                        >
                                            {!editingProduct.image && <span className="text-gray-400 text-sm">No Image</span>}
                                        </div>
                                        <input 
                                            type="file" 
                                            accept="image/*" 
                                            className="hidden" 
                                            ref={fileInputRef} 
                                            onChange={handleImageUpload} 
                                        />
                                        <button 
                                            onClick={() => fileInputRef.current.click()}
                                            className="flex items-center gap-2 text-blue-500 font-semibold py-2 px-4 rounded-lg bg-blue-50 active:scale-95 transition-transform"
                                        >
                                            <ImageIcon />
                                            {APP_CONFIG.ui.btnUpload}
                                        </button>
                                    </div>

                                    <div className="bg-white rounded-xl overflow-hidden mb-6">
                                        <div className="flex items-center px-4 py-3 border-b border-gray-100">
                                            <label className="w-24 text-gray-800">{APP_CONFIG.ui.fieldName}</label>
                                            <input className="flex-1 text-right outline-none" value={editingProduct.name} onChange={e => setEditingProduct({...editingProduct, name: e.target.value})} placeholder={APP_CONFIG.ui.fieldPlaceholder} />
                                        </div>
                                        <div className="flex items-center px-4 py-3 border-b border-gray-100">
                                            <label className="w-24 text-gray-800">{APP_CONFIG.ui.fieldSeries}</label>
                                            <input className="flex-1 text-right outline-none" value={editingProduct.series} onChange={e => setEditingProduct({...editingProduct, series: e.target.value})} placeholder={APP_CONFIG.ui.fieldSeries} />
                                        </div>
                                        <div className="flex items-center px-4 py-3">
                                            <label className="w-24 text-gray-800">{APP_CONFIG.ui.fieldCategory}</label>
                                            <select className="flex-1 bg-transparent text-right outline-none appearance-none" value={editingProduct.category} onChange={e => setEditingProduct({...editingProduct, category: e.target.value})}>
                                                {APP_CONFIG.categories.filter(c => c !== APP_CONFIG.categories[0]).map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl p-4 mb-6">
                                        <label className="block text-gray-400 text-xs mb-2 uppercase">{APP_CONFIG.ui.fieldMemo}</label>
                                        <textarea className="w-full h-24 outline-none resize-none" value={editingProduct.memo} onChange={e => setEditingProduct({...editingProduct, memo: e.target.value})} placeholder={APP_CONFIG.ui.fieldMemo + "..."} />
                                    </div>

                                    <button onClick={handleDelete} className="w-full bg-white text-red-500 py-4 rounded-xl font-bold active:bg-gray-100 mb-10">
                                        {APP_CONFIG.ui.btnDelete}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 h-20 bg-white/80 ios-blur border-t border-gray-300">
                        <div className="max-w-md mx-auto h-full flex justify-around items-center pb-4 text-[10px] text-gray-400">
                            <div className="flex flex-col items-center text-blue-500">
                                <div className="w-6 h-6 mb-1 bg-blue-500 rounded-md"></div>
                                <span>{APP_CONFIG.ui.navHome}</span>
                            </div>
                            <div className="flex flex-col items-center">
                                <div className="w-6 h-6 mb-1 bg-gray-200 rounded-md"></div>
                                <span>{APP_CONFIG.ui.navStats}</span>
                            </div>
                            <div className="flex flex-col items-center">
                                <div className="w-6 h-6 mb-1 bg-gray-200 rounded-md"></div>
                                <span>{APP_CONFIG.ui.navSettings}</span>
                            </div>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
