import React, { useState, useEffect, useRef } from 'react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, query } from 'firebase/firestore';

// --- Firebase ÈÖçÁΩÆËàáÂàùÂßãÂåñ ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = !getApps().length ? initializeApp(firebaseConfig) : getApps()[0];
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'goods-archive-v1';

const i18n = {
    zh: {
        title: "Èõ≤Á´ØÂÖ∏ËóèÈ§®",
        search: "ÊêúÂ∞ãÂêçÁ®±„ÄÅÁ≥ªÂàóÊàñÂ∑•ËóùÁ¥∞ÁØÄ...",
        all: "ÂÖ®ÈÉ®‰ΩúÂìÅ",
        acrylic: "Â£ìÂÖãÂäõ",
        badge: "ÂæΩÁ´†",
        apparel: "ÊúçÈ£æ",
        goods: "ÁîüÊ¥ªÈõúË≤®",
        others: "ÂÖ∂‰ªñ",
        add: "Êñ∞Â¢ûÂÖ∏Ëóè",
        edit: "Á∑®ËºØË©≥ÊÉÖ",
        save: "ÂÑ≤Â≠òÂà∞Èõ≤Á´Ø",
        cancel: "ÂèñÊ∂à",
        delete: "ÁßªÈô§Á¥ÄÈåÑ",
        ai_analyzing: "AI Ëæ®Ë≠ò‰∏≠...",
        upload_tip: "ÈªûÊìä‰∏äÂÇ≥ÊàñÊãçÁÖß‰ª•Ëá™ÂãïÂàÜÊûê",
        syncing: "Èõ≤Á´ØÂêåÊ≠•‰∏≠...",
        online: "Âú®Á∑öÂêåÊ≠•",
        user_id: "Êìç‰ΩúËÄÖ ID"
    }
};

export default function App() {
    const [apiKey] = useState(""); // ‰ΩøÁî®Áí∞Â¢ÉÊèê‰æõÁöÑÁ©∫Â≠ó‰∏≤
    const [user, setUser] = useState(null);
    const [products, setProducts] = useState([]);
    const [searchQuery, setSearchQuery] = useState('');
    const [activeTab, setActiveTab] = useState('all');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingProduct, setEditingProduct] = useState(null);
    const [isAiAnalyzing, setIsAiAnalyzing] = useState(false);
    const [isLoading, setIsLoading] = useState(true);
    const fileInputRef = useRef(null);

    const t = i18n.zh;
    const categories = ['all', 'acrylic', 'badge', 'apparel', 'goods', 'others'];

    // 1. ÂàùÂßãÂåñË∫´‰ªΩÈ©óË≠â (ÈÅµÂÆà Rule 3)
    useEffect(() => {
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth error", e);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, (u) => {
            setUser(u);
            if (u) setIsLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // 2. Âç≥ÊôÇÁõ£ËÅΩ Firestore (ÈÅµÂÆà Rule 1 & 2)
    useEffect(() => {
        if (!user) return;
        
        // Âö¥Ê†ºÈÅµÂÆàË∑ØÂæëË¶èÂâá: /artifacts/{appId}/public/data/{collectionName}
        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'merch');
        
        const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            // Âú®Ë®òÊÜ∂È´î‰∏≠ÈÄ≤Ë°åÊéíÂ∫è
            setProducts(data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)));
        }, (error) => {
            console.error("Firestore Listen Error:", error);
            if (error.code === 'permission-denied') {
                console.error("Ë´ãÁ¢∫Ë™ç Firebase Firestore Ë¶èÂâáÂ∑≤ÈñãÂïüÊ∏¨Ë©¶Ê®°Âºè");
            }
        });

        return () => unsubscribe();
    }, [user]);

    // 3. AI Ëæ®Ë≠òÈÇèËºØ
    const analyzeImage = async (base64Data) => {
        setIsAiAnalyzing(true);
        const pureBase64 = base64Data.split(',')[1];
        
        const prompt = `‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠ÈÄ±ÈÇäÂ∞àÂÆ∂„ÄÇÂàÜÊûêÊ≠§ÁÖßÁâá‰∏¶ÂõûÂÇ≥ JSONÔºö
        { "name": "ÂïÜÂìÅÂêç", "series": "IPÂêç", "category": "acrylic/badge/apparel/goods/others", "crafts": "Â∑•Ëóù", "memo": "ÊèèËø∞" }`;

        // ÊåáÊï∏ÈÄÄÈÅøÈáçË©¶Ê©üÂà∂
        const fetchWithRetry = async (retries = 5, delay = 1000) => {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: pureBase64 } }] }],
                        generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
                    })
                });
                return await response.json();
            } catch (e) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(retries - 1, delay * 2);
                }
                throw e;
            }
        };

        try {
            const result = await fetchWithRetry();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                const aiData = JSON.parse(text);
                setEditingProduct(prev => ({ ...prev, ...aiData }));
            }
        } catch (e) {
            console.error("AI Error", e);
        } finally {
            setIsAiAnalyzing(false);
        }
    };

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 800 * 1024) {
                alert("ÂúñÁâáËºÉÂ§ßÔºåË´ãÈÅ∏ÊìáÂ∞èÊñº 800KB ÁöÑÂúñÁâá‰ª•Á¢∫‰øùÈõ≤Á´ØÂÇ≥Ëº∏È†ÜÊö¢„ÄÇ");
                return;
            }
            const reader = new FileReader();
            reader.onloadend = () => {
                setEditingProduct(prev => ({ ...prev, image: reader.result }));
                analyzeImage(reader.result);
            };
            reader.readAsDataURL(file);
        }
    };

    const handleSave = async () => {
        if (!editingProduct.name || !user) return;
        
        const docId = editingProduct.id || Date.now().toString();
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'merch', docId);
        
        const saveData = {
            ...editingProduct,
            id: docId,
            lastUpdatedBy: user.uid,
            updatedAt: Date.now(),
            createdAt: editingProduct.createdAt || Date.now()
        };
        delete saveData.isNew;

        try {
            await setDoc(docRef, saveData);
            setIsModalOpen(false);
        } catch (e) {
            alert("ÂÑ≤Â≠òÂ§±Êïó: " + e.message);
        }
    };

    const handleDelete = async () => {
        if (!editingProduct.id || !user) return;
        try {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'merch', editingProduct.id);
            await deleteDoc(docRef);
            setIsModalOpen(false);
        } catch (e) {
            alert("Âà™Èô§Â§±Êïó");
        }
    };

    const filteredProducts = products.filter(p => 
        (p.name?.toLowerCase().includes(searchQuery.toLowerCase()) || 
         p.series?.toLowerCase().includes(searchQuery.toLowerCase())) &&
        (activeTab === 'all' || p.category === activeTab)
    );

    if (isLoading) return <div className="flex h-screen items-center justify-center text-indigo-600 font-bold animate-pulse">ÂàùÂßãÂåñÈõ≤Á´ØÁ≥ªÁµ±...</div>;

    return (
        <div className="max-w-md mx-auto min-h-screen pb-24 relative bg-[#F8F9FA] font-sans">
            <style>{`
                .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
                .hide-scrollbar::-webkit-scrollbar { display: none; }
                .modal-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
                @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
                .scan-line { width: 100%; height: 2px; background: #4F46E5; position: absolute; top: 0; left: 0; animation: scan 2s infinite linear; box-shadow: 0 0 15px #4F46E5; z-index: 10; }
                @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
                .craft-tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: #EEF2FF; color: #4F46E5; font-weight: 600; border: 1px solid #E0E7FF; }
            `}</style>

            <div className="p-4 pt-12">
                {/* Header */}
                <div className="flex justify-between items-start mb-6">
                    <div>
                        <h1 className="text-3xl font-black text-gray-900 tracking-tight flex items-center gap-2">
                            {t.title}
                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        </h1>
                        <p className="text-gray-400 text-[10px] mt-1 font-bold uppercase tracking-widest">{t.online} ‚Ä¢ UID: {user?.uid.slice(0,8)}...</p>
                    </div>
                    <button 
                        onClick={() => {
                            setEditingProduct({ name: '', category: 'acrylic', series: '', crafts: '', memo: '', image: '', isNew: true });
                            setIsModalOpen(true);
                        }} 
                        className="bg-indigo-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-transform text-2xl"
                    >+</button>
                </div>

                {/* Search */}
                <div className="bg-white rounded-2xl flex items-center px-4 py-3.5 mb-6 shadow-sm border border-gray-100 focus-within:border-indigo-300 transition-all">
                    <span className="mr-3 opacity-30 text-lg">üîç</span>
                    <input className="bg-transparent border-none outline-none w-full text-sm font-medium" placeholder={t.search} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                </div>

                {/* Categories */}
                <div className="flex overflow-x-auto hide-scrollbar gap-2 mb-8">
                    {categories.map(cat => (
                        <button key={cat} onClick={() => setActiveTab(cat)} className={`px-5 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all ${activeTab === cat ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-400 border border-gray-100'}`}>
                            {t[cat]}
                        </button>
                    ))}
                </div>

                {/* Grid */}
                <div className="grid grid-cols-2 gap-5">
                    {filteredProducts.length === 0 ? (
                        <div className="col-span-2 py-20 text-center opacity-20">
                            <span className="text-6xl">‚òÅÔ∏è</span>
                            <p className="mt-4 font-bold">Èõ≤Á´ØÂ∞öÁÑ°ÂÖ∏Ëóè</p>
                        </div>
                    ) : filteredProducts.map(p => (
                        <div key={p.id} onClick={() => { setEditingProduct({...p}); setIsModalOpen(true); }} className="bg-white rounded-[28px] overflow-hidden shadow-sm border border-gray-100 active:scale-[0.98] transition-all relative flex flex-col">
                            <div className="h-40 bg-cover bg-center bg-gray-50" style={{ backgroundImage: `url(${p.image || 'https://via.placeholder.com/300?text=No+Image'})` }} />
                            <div className="p-4 flex-1">
                                <p className="text-[10px] text-indigo-500 font-bold truncate uppercase mb-1 tracking-wider">{p.series || 'Êú™ÂàÜÈ°ûÁ≥ªÂàó'}</p>
                                <h3 className="font-bold text-gray-800 text-sm line-clamp-1">{p.name}</h3>
                                <div className="mt-2 flex items-center">
                                    <span className="craft-tag truncate">{p.crafts?.split('„ÄÅ')[0] || p.category}</span>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Editor Modal */}
            {isModalOpen && editingProduct && (
                <div className="fixed inset-0 z-50 flex items-end">
                    <div className="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" onClick={() => !isAiAnalyzing && setIsModalOpen(false)} />
                    <div className="relative w-full max-w-md mx-auto bg-white rounded-t-[40px] h-[94vh] flex flex-col modal-up overflow-hidden">
                        <div className="flex justify-between items-center px-8 py-5 border-b border-gray-50">
                            <button onClick={() => setIsModalOpen(false)} className="text-gray-400 font-bold text-sm">{t.cancel}</button>
                            <h2 className="font-extrabold text-gray-800">{editingProduct.isNew ? t.add : t.edit}</h2>
                            <button onClick={handleSave} className="text-indigo-600 font-bold" disabled={isAiAnalyzing}>{t.save}</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-8 space-y-6">
                            <div className="flex flex-col items-center">
                                <div 
                                    className={`w-48 h-48 bg-gray-50 rounded-[40px] shadow-inner flex items-center justify-center overflow-hidden relative border-4 transition-all ${isAiAnalyzing ? 'border-indigo-400' : 'border-white'}`} 
                                    onClick={() => !isAiAnalyzing && fileInputRef.current.click()}
                                >
                                    {editingProduct.image ? <img src={editingProduct.image} className="w-full h-full object-cover" alt="preview" /> : <span className="text-5xl opacity-10">üì∏</span>}
                                    {isAiAnalyzing && (
                                        <div className="absolute inset-0 bg-white/40 flex items-center justify-center">
                                            <div className="scan-line"></div>
                                            <div className="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                        </div>
                                    )}
                                </div>
                                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} accept="image/*" />
                                <p className="mt-4 text-[11px] font-black text-indigo-600 uppercase tracking-widest">{isAiAnalyzing ? t.ai_analyzing : t.upload_tip}</p>
                            </div>

                            <div className="space-y-4 pb-12">
                                <div className="bg-gray-50 p-5 rounded-3xl">
                                    <label className="text-[10px] text-gray-400 block mb-1.5 uppercase font-black tracking-widest">{t.name}</label>
                                    <input className="w-full bg-transparent outline-none font-bold text-gray-800" value={editingProduct.name} onChange={e => setEditingProduct({...editingProduct, name: e.target.value})} placeholder="ÂêçÁ®±..." />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-gray-50 p-5 rounded-3xl">
                                        <label className="text-[10px] text-gray-400 block mb-1.5 uppercase font-black tracking-widest">{t.series}</label>
                                        <input className="w-full bg-transparent outline-none font-bold text-gray-700" value={editingProduct.series} onChange={e => setEditingProduct({...editingProduct, series: e.target.value})} placeholder="Á≥ªÂàó..." />
                                    </div>
                                    <div className="bg-gray-50 p-5 rounded-3xl">
                                        <label className="text-[10px] text-gray-400 block mb-1.5 uppercase font-black tracking-widest">{t.category}</label>
                                        <select className="w-full bg-transparent outline-none font-bold text-indigo-600 appearance-none" value={editingProduct.category} onChange={e => setEditingProduct({...editingProduct, category: e.target.value})}>
                                            {categories.filter(c => c !== 'all').map(c => <option key={c} value={c}>{t[c]}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-5 rounded-3xl">
                                    <label className="text-[10px] text-gray-400 block mb-1.5 uppercase font-black tracking-widest">{t.crafts}</label>
                                    <input className="w-full bg-transparent outline-none font-bold text-gray-700" value={editingProduct.crafts} onChange={e => setEditingProduct({...editingProduct, crafts: e.target.value})} placeholder="Â∑•ËóùÁ¥∞ÁØÄ..." />
                                </div>
                                <div className="bg-gray-50 p-5 rounded-3xl">
                                    <label className="text-[10px] text-gray-400 block mb-1.5 uppercase font-black tracking-widest">{t.memo}</label>
                                    <textarea className="w-full bg-transparent outline-none text-sm h-24 resize-none text-gray-600" value={editingProduct.memo} onChange={e => setEditingProduct({...editingProduct, memo: e.target.value})} />
                                </div>
                                
                                {!editingProduct.isNew && (
                                    <button onClick={handleDelete} className="w-full py-5 text-rose-500 font-extrabold bg-rose-50 rounded-3xl mt-4 active:scale-95 transition-transform">ÁßªÈô§Á¥ÄÈåÑ</button>
                                )}
                                
                                <div className="text-center opacity-30 text-[9px] font-medium py-4">
                                    ÊúÄÂæåÁ∑®ËºØËÄÖ: {editingProduct.lastUpdatedBy || 'System'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
